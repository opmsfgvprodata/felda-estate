@model IEnumerable<MVC_SYSTEM.Models.sp_Payslip_Result>
@using MVC_SYSTEM.Class
@using MVC_SYSTEM.Models;

@{
    ViewBag.Title = "_PaySlipRptDetail";
    //Layout = "~/Views/Shared/_LayoutMain.cshtml";

    GetTriager GetTriager = new GetTriager();
    GetEstateDetail GetGroup = new GetEstateDetail();
    GetConfig GetConfig = new GetConfig();
    var attWorkDatas = ViewBag.AttWorkDatas as List<MVC_SYSTEM.Models.tbl_Kerjahdr>;
    var hardWorkDatas = ViewBag.HardWorkDatas as List<MVC_SYSTEM.Models.tbl_Kerja>;
    var webConfigList = ViewBag.WebConfigList as List<MVC_SYSTEM.MasterModels.tblOptionConfigsWeb>;
    var pktHargaKesukaran = ViewBag.PktHargaKesukaran as List<tbl_PktHargaKesukaran>;
    var hardWorkDatasNew = ViewBag.HardWorkDatasNew as List<tbl_KerjaKesukaran>;
}

@if (Model.Count() > 0)
{
    foreach (var pkj in Model.Select(s => s.fldNopkj).Distinct())
    {
        <div style="page-break-before: always;">
            <p style="font-size: 11px" align="right">@GlobalResEstate.lblDate : @ViewBag.Date</p>

            <table id="page" class="table" style="font-size: 11px; margin-bottom: 0px" border="0" cellspacing="0">
                <thead>
                    <tr>
                        <th colspan="18" style="text-align: center; vertical-align: middle; border: none;">
                            <img src="~/Asset/Images/logo_FTPSB.jpg" height="60" width="60" />
                            <br />
                            @ViewBag.NamaSyarikat
                            <br />
                            (@ViewBag.NoSyarikat)
                            <br />
                            @ViewBag.NamaLadang
                            <br />
                            @GlobalResEstate.lblPayslipReport @GlobalResEstate.hdrForMonth @ViewBag.Month/@ViewBag.Year
                            <br />
                            <br />
                            <br />
                            <br />
                        </th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td width="4%" style="font-weight: bold; vertical-align: middle !important; border:none;">@GlobalResEstate.hdrNoPkj</td>
                        <td width="4%" style="vertical-align: middle !important; border:none;">: @pkj</td>
                        <td width="4%" style="font-weight: bold; vertical-align: middle !important; border:none;">@GlobalResEstate.hdrName</td>
                        <td width="4%" style="vertical-align: middle !important; border:none;">: @ViewBag.NamaPkj</td>
                        <td width="4%" style="font-weight: bold; vertical-align: middle !important; border:none;">@GlobalResEstate.lblNoKwsp</td>
                        <td width="4%" style="vertical-align: middle !important; border:none;">: @GetTriager.GetDashForNull(ViewBag.NoKwsp)</td>
                    </tr>
                    <tr>
                        <td width="4%" style="font-weight: bold; vertical-align: middle !important; border:none;">@GlobalResEstate.hdrGroupCode</td>
                        <td width="4%" style="vertical-align: middle !important; border:none;">: @ViewBag.Kump</td>
                        <td width="4%" style="font-weight: bold; vertical-align: middle !important; border:none;">@GlobalResEstate.lblPosition</td>
                        <td width="4%" style="vertical-align: middle !important; border:none;">: @ViewBag.Kategori</td>
                        <td width="4%" style="font-weight: bold; vertical-align: middle !important; border:none;">@GlobalResEstate.lblNoSocso</td>
                        <td width="4%" style="vertical-align: middle !important; border:none;">: @GetTriager.GetDashForNull(ViewBag.NoSocso)</td>
                    </tr>
                    <tr>
                        <td width="4%" style="font-weight: bold; vertical-align: middle !important; border:none;">@GlobalResEstate.lblGender</td>
                        <td width="4%" style="vertical-align: middle !important; border:none;">: @ViewBag.Jantina</td>
                        <td width="4%" style="font-weight: bold; vertical-align: middle !important; border:none;">@GlobalResEstate.hdrNoKp</td>
                        <td width="4%" style="vertical-align: middle !important; border:none;">: @ViewBag.NoKp</td>
                        <td width="4%" style="font-weight: bold; vertical-align: middle !important; border:none;"></td>
                        <td width="4%" style="vertical-align: middle !important; border:none;"></td>
                    </tr>
                    <tr>
                        <td width="4%" style="font-weight: bold; vertical-align: middle !important; border:none;">&nbsp;</td>
                        <td width="4%" style="vertical-align: middle !important; border:none;"></td>
                        <td width="4%" style="font-weight: bold; vertical-align: middle !important; border:none;"></td>
                        <td width="4%" style="vertical-align: middle !important; border:none;"></td>
                        <td width="4%" style="font-weight: bold; vertical-align: middle !important; border:none;"></td>
                        <td width="4%" style="vertical-align: middle !important; border:none;"></td>
                    </tr>
                </tbody>
            </table>

            <table style="float: left; width: 65%; font-size: 11px; margin-bottom: 10px" class="table" cellspacing="0">
                <thead>
                    <tr>
                        <th colspan="6" width="1%" style="margin: 2px !important; margin: !important; padding: 2px !important; text-align: center; vertical-align: middle !important; border-top: 1px solid red;border-left: 1px solid red;border-bottom: 1px solid red; border-right: 1px solid red;" border="1">@GlobalResEstate.hdrEarning</th>
                    </tr>
                    <tr>
                        <th width="2%" style="margin: 2px !important; padding: 2px !important; text-align: center; vertical-align: middle !important;border-left: 1px solid red;border-bottom: 1px solid red;">@GlobalResEstate.hdrDesc</th>
                        <th width="1%" style="margin: 2px !important; padding: 2px !important; text-align: center; vertical-align: middle !important;border-left: 1px solid red;border-bottom: 1px solid red;">@GlobalResEstate.hdrQuantity</th>
                        <th width="1%" style="margin: 2px !important; padding: 2px !important; text-align: center; vertical-align: middle !important;border-left: 1px solid red;border-bottom: 1px solid red;">@GlobalResEstate.hdrUnit</th>
                        <th width="2%" style="margin: 2px !important; padding: 2px !important; text-align: center; vertical-align: middle !important;border-left: 1px solid red;border-bottom: 1px solid red;">@GlobalResEstate.hdrRate (RM)</th>
                        <th width="1%" style="margin: 2px !important; padding: 2px !important; text-align: center; vertical-align: middle !important;border-left: 1px solid red;border-bottom: 1px solid red;">@GlobalResEstate.lblMultiples</th>
                        <th width="2%" style="margin: 2px !important; padding: 2px !important; text-align: center; vertical-align: middle !important;border-left: 1px solid red;border-right: 1px solid red;border-bottom: 1px solid red;">@GlobalResEstate.lblTotal (RM)</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model.Where(x => x.fldNopkj == pkj && x.fldFlag <= 2))
                    {
                        if (item.fldKeterangan != "AIPS")
                        {
                            decimal? hardWorkPrice = 0;
                            decimal? totalAmount = 0;
                            decimal? quantity = 0;
                            List<MVC_SYSTEM.Models.tbl_Kerja> hardWorkData = null;
                            List<tbl_KerjaKesukaran> hardWorkDataNew = null;
                            if (item.fldKodPkt != null)
                            {
                                string codeAtt = "";
                                switch (item.fldGandaan)
                                {
                                    case 1:
                                        codeAtt = "H01";
                                        break;
                                    case 2:
                                        codeAtt = "H02";
                                        break;
                                    case 3:
                                        codeAtt = "H03";
                                        break;
                                }
                                var attWorkDate = attWorkDatas.Where(x => x.fld_Kdhdct == codeAtt).Select(s => s.fld_Tarikh).ToArray();
                                hardWorkData = hardWorkDatas.Where(x => x.fld_KodPkt == item.fldKodPkt && x.fld_KodAktvt == item.fldKod && attWorkDate.Contains(x.fld_Tarikh)).ToList();
                                var hardWorkDataIDs = hardWorkData.Select(s => s.fld_ID).ToList();
                                var hardWorkDataNewFilter = hardWorkDatasNew.Where(x => hardWorkDataIDs.Contains(x.fld_KerjaID.Value)).ToList();
                                quantity = hardWorkDatas.Where(x => x.fld_KodPkt == item.fldKodPkt).Sum(s => s.fld_JumlahHasil);
                                hardWorkPrice = hardWorkData.Where(x => x.fld_KodPkt == item.fldKodPkt).Sum(s => s.fld_HrgaKwsnSkar);
                                var hardWorkPriceIDs = hardWorkData.Where(x => x.fld_KodPkt == item.fldKodPkt).Select(s => s.fld_ID).ToList();
                                hardWorkDataNew = hardWorkDataNewFilter.Where(x => hardWorkPriceIDs.Contains(x.fld_KerjaID.Value)).ToList();
                                totalAmount = item.fldJumlah - hardWorkPrice;
                            }
                            else
                            {
                                totalAmount = item.fldJumlah;
                            }
                            <tr>
                                @if (item.fldKodPkt != null)
                                {
                                    <td width="4%" style="margin: 2px !important; padding: 2px !important; vertical-align: middle !important; border-bottom: 1px dotted gray; border-right: none; border-left: none">@item.fldKeterangan</td>
                                }
                                else
                                {
                                    <td width="4%" style="margin: 2px !important; padding: 2px !important; vertical-align: middle !important; border-bottom: 1px dotted gray; border-right: none; border-left: none">@item.fldKeterangan</td>
                                }
                                <td width="1%" style="margin: 2px !important; padding: 2px !important; vertical-align: middle !important; border-bottom: 1px dotted gray; text-align: right; border-right: none; border-left: none">@GetTriager.GetDashForNull(item.fldKuantiti.ToString())</td>
                                <td width="1%" style="margin: 2px !important; padding: 2px !important; vertical-align: middle !important; border-bottom: 1px dotted gray; text-align: right; border-right: none; border-left: none">@GetTriager.GetDashForNull(item.fldUnit)</td>
                                <td width="1%" style="margin: 2px !important; padding: 2px !important; vertical-align: middle !important; border-bottom: 1px dotted gray; text-align: right; border-right: none; border-left: none">@GetTriager.GetDashForNull(item.fldKadar.ToString())</td>
                                <td width="1%" style="margin: 2px !important; padding: 2px !important; vertical-align: middle !important; border-bottom: 1px dotted gray; text-align: right; border-right: none; border-left: none">@GetTriager.GetDashForNull(item.fldGandaan.ToString())</td>
                                <td width="1.5%" style="margin: 2px !important; padding: 2px !important; vertical-align: middle !important; border-bottom: 1px dotted gray; text-align: right; border-right: none; border-left: none">@GetTriager.GetTotalForMoney(totalAmount)</td>
                            </tr>
                            if (hardWorkPrice > 0)
                            {
                                var hardWorkCode = hardWorkData.Select(s => s.fld_KodKwsnSkar).FirstOrDefault();
                                if (hardWorkCode == "**")
                                {
                                    foreach (var item2 in hardWorkDataNew)
                                    {
                                        var hardWorkDesc = pktHargaKesukaran.Where(x => x.fld_KodHargaKesukaran == item2.fld_KodKesukaran).Select(s => s.fld_KeteranganHargaKesukaran).FirstOrDefault();
                                        var hardWorkRate = pktHargaKesukaran.Where(x => x.fld_KodHargaKesukaran == item2.fld_KodKesukaran).Select(s => s.fld_HargaKesukaran).FirstOrDefault();
                                        var desc = item.fldKeterangan + " (" + hardWorkDesc + ")";
                                        <tr>
                                            <td width="4%" style="margin: 2px !important; padding: 2px !important; vertical-align: middle !important; border-bottom: 1px dotted gray; border-right: none; border-left: none">@desc</td>
                                            <td width="1%" style="margin: 2px !important; padding: 2px !important; vertical-align: middle !important; border-bottom: 1px dotted gray; text-align: right; border-right: none; border-left: none">-@*@GetTriager.GetDashForNull(quantity.ToString())*@</td>
                                            <td width="1%" style="margin: 2px !important; padding: 2px !important; vertical-align: middle !important; border-bottom: 1px dotted gray; text-align: right; border-right: none; border-left: none">-</td>
                                            <td width="1%" style="margin: 2px !important; padding: 2px !important; vertical-align: middle !important; border-bottom: 1px dotted gray; text-align: right; border-right: none; border-left: none">@GetTriager.GetDashForNull(item2.fld_Kadar.ToString())</td>
                                            <td width="1%" style="margin: 2px !important; padding: 2px !important; vertical-align: middle !important; border-bottom: 1px dotted gray; text-align: right; border-right: none; border-left: none"></td>
                                            <td width="1.5%" style="margin: 2px !important; padding: 2px !important; vertical-align: middle !important; border-bottom: 1px dotted gray; text-align: right; border-right: none; border-left: none">@GetTriager.GetTotalForMoney(item2.fld_Jumlah)</td>
                                        </tr>
                                    }
                                }
                                else
                                {
                                    var hardWorkDesc = pktHargaKesukaran.Where(x => x.fld_KodHargaKesukaran == hardWorkCode).Select(s => s.fld_KeteranganHargaKesukaran).FirstOrDefault();
                                    var hardWorkRate = pktHargaKesukaran.Where(x => x.fld_KodHargaKesukaran == hardWorkCode).Select(s => s.fld_HargaKesukaran).FirstOrDefault();
                                    var desc = item.fldKeterangan + " (" + hardWorkDesc + ")";
                                    <tr>
                                        <td width="4%" style="margin: 2px !important; padding: 2px !important; vertical-align: middle !important; border-bottom: 1px dotted gray; border-right: none; border-left: none">@desc</td>
                                        <td width="1%" style="margin: 2px !important; padding: 2px !important; vertical-align: middle !important; border-bottom: 1px dotted gray; text-align: right; border-right: none; border-left: none">-@*@GetTriager.GetDashForNull(quantity.ToString())*@</td>
                                        <td width="1%" style="margin: 2px !important; padding: 2px !important; vertical-align: middle !important; border-bottom: 1px dotted gray; text-align: right; border-right: none; border-left: none">-</td>
                                        <td width="1%" style="margin: 2px !important; padding: 2px !important; vertical-align: middle !important; border-bottom: 1px dotted gray; text-align: right; border-right: none; border-left: none">@GetTriager.GetDashForNull(hardWorkRate.ToString())</td>
                                        <td width="1%" style="margin: 2px !important; padding: 2px !important; vertical-align: middle !important; border-bottom: 1px dotted gray; text-align: right; border-right: none; border-left: none"></td>
                                        <td width="1.5%" style="margin: 2px !important; padding: 2px !important; vertical-align: middle !important; border-bottom: 1px dotted gray; text-align: right; border-right: none; border-left: none">@GetTriager.GetTotalForMoney(hardWorkPrice)</td>
                                    </tr>
                                }
                            }
                        }
                    }
                </tbody>
            </table>

            <table style="float: left; width: 35%; font-size: 11px; margin-bottom: 10px" class="table" border="0" cellspacing="0">
                <thead>
                    <tr>
                        <th colspan="2" width="1%" style="margin: 2px !important; padding: 2px !important; text-align: center; vertical-align: middle !important; border-top: 1px solid red;border-bottom: 1px solid red;border-right: 1px solid red;" border="1">@GlobalResEstate.hdrDeduction</th>
                    </tr>
                    <tr>
                        <th width="1%" style="margin: 2px !important; padding: 2px !important; text-align: center; vertical-align: middle !important; border-right: 1px solid red;border-bottom: 1px solid red;">@GlobalResEstate.hdrDesc</th>
                        <th width="2%" style="margin: 2px !important; padding: 2px !important; text-align: center; vertical-align: middle !important; border-right: 1px solid red;border-bottom: 1px solid red;">@GlobalResEstate.lblTotal (RM)</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item2 in Model.Where(x => x.fldNopkj == pkj && x.fldFlag == 3))
                    {
                        <tr>
                            <td width="4%" style="margin: 2px !important; padding: 2px !important; vertical-align: middle !important; border-bottom: 1px dotted gray; border-right: none; border-right: none; border-left: none">@item2.fldKeterangan</td>
                            <td width="2%" style="margin: 2px !important; padding: 2px !important; vertical-align: middle !important; border-bottom: 1px dotted gray; text-align: right; border-right: none; border-left: none">@GetTriager.GetTotalForMoney(item2.fldJumlah)</td>
                        </tr>
                    }
                </tbody>
            </table>
            @{
                decimal? TotalPendapatan = Model.Where(x => x.fldFlag == 2).Select(s => s.fldJumlah).Sum();
                decimal? TotalPotongan = Model.Where(x => x.fldFlag == 3).Select(s => s.fldJumlah).Sum();
                decimal GajiBersih = TotalPendapatan.Value - TotalPotongan.Value;
            }
            <table style="float: left; width: 65%; font-size: 11px;" class="table" border="0" cellspacing="0">
                <thead>

                    <tr>
                        <th width="4%" style="margin: 2px !important; padding: 2px !important; text-align: center; vertical-align: middle !important; border-top: 1px solid red; border-bottom: none;"></th>
                        <th width="1%" style="margin: 2px !important; padding: 2px !important; text-align: center; vertical-align: middle !important; border-top: 1px solid red; border-bottom: none;"></th>
                        <th width="1%" style="margin: 2px !important; padding: 2px !important; text-align: center; vertical-align: middle !important; border-top: 1px solid red; border-bottom: none;"></th>
                        <th width="1%" style="margin: 2px !important; padding: 2px !important; text-align: center; vertical-align: middle !important; border-top: 1px solid red; border-bottom: none;"></th>
                        <th width="2%" style="margin: 2px !important; padding: 2px !important; text-align: right; vertical-align: middle !important; border-top: 1px solid red; border-bottom: none;">@GlobalResEstate.lblTotalEarning</th>
                        <th width="1.5%" style="margin: 2px !important; padding: 2px !important; text-align: right; vertical-align: middle !important; border-top: 1px solid red; border-bottom: 1px double red; border-right: none;">@GetTriager.GetTotalForMoney(TotalPendapatan)</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>

            <table style="float: left; width: 35%; font-size: 11px;" class="table" border="0" cellspacing="0">
                <thead>
                    <tr>
                        <th width="4%" style="margin: 2px !important; padding: 2px !important; text-align: right; vertical-align: middle !important; border-top: 1px solid red; border-bottom: none; border-left: none;">@GlobalResEstate.lblTotalDeduction</th>
                        <th width="2%" style="margin: 2px !important; padding: 2px !important; text-align: right; vertical-align: middle !important; border-top: 1px solid red; border-bottom: 1px double red; border-right: none;">@GetTriager.GetTotalForMoney(TotalPotongan)</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>

            <table style="float: left; width: 65%; font-size: 11px;" class="table" border="0" cellspacing="0">
                <thead>
                    <tr>
                        <th width="4%" style="margin: 2px !important; padding: 2px !important; text-align: center; vertical-align: middle !important; border: none;"></th>
                        <th width="1%" style="margin: 2px !important; padding: 2px !important; text-align: center; vertical-align: middle !important; border: none;"></th>
                        <th width="1%" style="margin: 2px !important; padding: 2px !important; text-align: center; vertical-align: middle !important; border: none;"></th>
                        <th width="1%" style="margin: 2px !important; padding: 2px !important; text-align: center; vertical-align: middle !important; border: none;"></th>
                        <th width="2%" style="margin: 2px !important; padding: 2px !important; text-align: center; vertical-align: middle !important; border: none;"></th>
                        <th width="1.5%" style="margin: 2px !important; padding: 2px !important; text-align: center; vertical-align: middle !important; border: none;"></th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>

            <table style="float: left; width: 35%; font-size: 11px; margin-bottom: 10px" class="table" border="0" cellspacing="0">
                <thead>
                    <tr>
                        <th width="4%" style="margin: 2px !important; padding: 2px !important; text-align: right; vertical-align: middle !important; border: none;">@GlobalResEstate.hdrNetSalary</th>
                        <th width="2%" style="margin: 2px !important; padding: 2px !important; text-align: right; vertical-align: middle !important; border-bottom: 1px double red; border-right: none;">@GetTriager.GetTotalForMoney(GajiBersih)</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>

            <table style="float: left; width: 100%; font-size: 11px; margin-bottom: 5px" class="table" border="0" cellspacing="0">
                <thead>
                    <tr>
                        <th colspan="2" style="margin: 2px !important; padding: 2px !important; text-align: right; vertical-align: middle !important; border-top: 2px solid gray; border-bottom: none; border-left: none;"></th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>

            <table style="float: left; width: 80%; font-size: 11px;" class="table" border="0" cellspacing="0">
                <thead>
                    <tr>
                        <th width="4%" style="margin: 2px !important; padding: 2px !important; text-align: left; vertical-align: middle !important; border: none;">*@GlobalResEstate.lblMultiples : 1 = @GlobalResEstate.lblWeedays, 2 = @GlobalResEstate.lblWeekend, 3 = @GlobalResEstate.lblPublicHoliday2</th>
                    </tr>
                    <tr>
                        <th width="4%" style="margin: 2px !important; padding: 2px !important; text-align: left; vertical-align: middle !important; border: none;">*@GlobalResEstate.lblBonusMultiples : 0.5 = 50% @GlobalResEstate.lblAchievement, 1 = 100% @GlobalResEstate.lblAchievement</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>

            <table style="float: left; width: 100%; font-size: 11px; border-top: 1px solid red; ; border-bottom: 1px solid red; border-left: 1px solid red; ; border-right: 1px solid red;" class="table" border="0" cellspacing="0">
                <thead>
                    <tr>
                        <th colspan="6" style="margin: 2px !important; padding: 2px !important; text-align: center; vertical-align: middle !important;  border-bottom: 1px solid red">@GlobalResEstate.lblDetail</th>
                    </tr>
                </thead>
                <tbody>
                    @Html.Action("_PaySlipRptDaycount", "Report", new { nopkj = pkj, month = ViewBag.Month, year = ViewBag.Year })
                </tbody>
            </table>
            <div class="clearfix"></div>
        </div>
        <newpage />
    }
}


<style>
    #page td {
        padding: 2px;
        margin: 2px;
    }
</style>